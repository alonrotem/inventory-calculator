
<!--
User requesting account 
    -> administrator approving account with role -> account creation code
    -> user receices approval email + code 
    ->  User is creating new account, assigned a role, deleting the code
-->
<app-confirmation-dialog 
    #confirm_approval_dialog
    [modalTitle]="'Approve account?'"
    [btnYesClass]="'btn-success'"
    [btnYesIcon]="faCheck"
    [btnYesText]="'Approve'"
    [btnNoText]="'Cancel'"
    (confirm)="confirm_approval_confirmed()"
    />

<app-confirmation-dialog 
    #confirm_deletion_dialog
    [modalTitle]="'Delete request?'"
    [btnYesClass]="'btn-danger'"
    [btnYesIcon]="faTrash"
    [btnYesText]="'Delete'"
    [btnNoText]="'Cancel'"
    (confirm)="delete_request_confirmed()"
    />

<div class="row justify-content-center">
<div class="col-12 col-md-8">

<h3><fa-icon [icon]="faUserPlus"></fa-icon> Account request from {{ request.firstname }} {{ request.lastname }}</h3>

<!-- Autocomplete -->
<div class="row">
    <div class="col">
        <h4>Request status:</h4>
        <p><strong>Request status:</strong><span class="status-{{ request.request_status }}"> {{ request.request_status }}</span></p>
        <p><strong>Requested at: {{ request.request_date | dateStr }}</strong></p>
        <p *ngIf="request.last_update != request.request_date"><strong>Last updated at: {{ request.last_update| dateStr }}</strong></p>
    </div>
</div>
<div class="row">
    <div class="col">
        <h4>Account details:</h4>
        <p><strong>Name:</strong> {{ request.firstname }} {{ request.lastname }}</p>
        <p><strong>Email:</strong> {{ request.email }}</p>
        <p><strong>Phone:</strong> {{ request.phone }}</p>
        <div><strong>Details:</strong><br/><div>{{ request.details }}</div></div>
    </div>
</div>
<div class="row">
    <div class="col approval-status">
        <h4>Approval status:</h4>
        <div [hidden]="request.request_status!='pending'">
            <div class="text-warning">This request is pending an administrator's approval.</div>
            <div>If you approve this request, a new user account will be created.</div>
            
            <div class="d-flex direction-row align-items-center justify-content-start mb-4 mt-4">
                <div>
                    Choose a role for this user
                </div>
                <div>
                    <ng-select         
                        #role_select 
                        [items]="roles" 
                        name="role_select" 
                        [multiple]="false" 
                        bindLabel="name" 
                        bindValue="id" 
                        [placeholder]="'Pick a role'"
                        (change)="role_selected($event)"
                        class="roles-select"
                        />
                </div>
                
            </div>
            <div class="mt-4 mb-4">
                <div class="text-danger" [hidden]="!request || !request.role || request.role.name.toLowerCase()!='administrator'">
                    <fa-icon [icon]="faTriangleExclamation" class="text-warning me-2"></fa-icon>
                    <strong><span class="text-warning">Careful!</span> An administrator has unlimited access!</strong>
                </div>
                <div [hidden]="!request || !request.role || request.role.name.toLowerCase()!='customer'">
                    <div class="mt-4 mb-4">This user will be connected to the following customer(s):</div>
                    <div class="mt-4 mb-4">
                        <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="chkCreateNewCustoemr" #chkCreateNewCustoemr (change)="set_instructions_and_approval_btn_status()" [(ngModel)]="request.create_new_customer">
                        <label class="form-check-label" for="chkCreateNewCustoemr">
                            Create a new customer in the system for this user
                        </label>
                        </div>                        
                    </div>
                    <div class="mt-4 mb-4"><strong>Connect this user to the following existing customers:</strong></div>
                    <app-customer-picker 
                        #customer_picker 
                        [(pickedCustomers)]="request.customers" 
                        (Change)="set_instructions_and_approval_btn_status()"
                        />
                </div>
                <div class="text-warning" [hidden]="!request || !request.role || request.role.name.toLowerCase()!='employee'">
                    Employees have access to orders and speficically approved system areas.
                </div>
                <div class="text-warning" [hidden]="!request || !request.role || request.role.name.toLowerCase()!='guest'">
                    Guests have specicially <em>READONLY</em> access to some areas.
                </div>
            </div>
            <div class="mt-4 mb-4">
                <div class="text-warning">{{ approval_instructions }}</div>
                <div>
                    <button class="btn btn-success" [disabled]="approve_btn_disabled" (click)="confirm_approval()"><fa-icon [icon]="faCheck"></fa-icon><br/>Approve this request</button>
                    <button class="btn btn-warning"><fa-icon [icon]="faX"></fa-icon><br/>Decline</button>
                </div>
            </div>
        </div>

        <div [hidden]="request.request_status!='approved'">
            <div class="horizontal">
                <div>This request was approved by</div>
                <app-user-tag 
                    [firstname]="request.approver_firstname"
                    [lastname]="request.approver_lastnme"
                    [user_id]="request.approver_user_id"
                    [photo_url]="request.approver_photo_url"
                />       
            </div>
            <div>Last updated on {{ request.last_update | dateStr}}.</div>
            <hr>

            <h3>Associated user</h3>
            <div class="horizontal">
                <div>The following user was created:</div>
                <app-user-tag 
                    [firstname]="request.user_firstname"
                    [lastname]="request.user_lastname"
                    [user_id]="request.approved_account_user_id"
                    [photo_url]="request.user_photo_url"
                    /> 
            </div>
            
            <div class="mt-3"><strong class="text-success">User role:</strong> {{ request.role.name }}</div>

            <div class="mt-3" *ngIf="request.customers && request.customers.length > 0">
                <p>The user is linked to the following customers:</p>

                    <table class="table table-responsive table-striped table-hover">
                        <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <td scope="col" class="text-center">Orders</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr 
                            *ngFor="let customer of request.customers" 
                            role="button">
                            <td routerLink="/inventory/customer/editor" [queryParams]="{ id: customer.id }">{{ customer.name }}</td>
                            <td style="width: 1px;">
                            <button class="btn btn-outline-primary" style="text-wrap-mode: nowrap;" (click)="go_to_orders(customer.id, customer.name)">
                                <div><fa-icon [icon]="faBasketShopping"></fa-icon> Orders</div>
                            </button>
                            </td>        
                        </tr>
                        </tbody>
                    </table>
            </div>
            <div class="mt-3" *ngIf="!request.customers || request.customers.length == 0">
                <p>This user is not linked to any customers.</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col">
        <button class="btn btn-danger" (click)="deleteRequest()"><fa-icon [icon]="faTrash"></fa-icon><br/>Delete</button>
    </div>
</div>
